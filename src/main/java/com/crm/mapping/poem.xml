<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.crm.dao.PoemDao">
	<resultMap type="com.crm.model.Poem" id="poemMap">
		<id property="poemId" column="poem_id"/>
		<result property="userId" column="user_id" />
		<result property="poemText" column="poem_text" />
		<result property="poemTitle" column="poem_title" />
		<result property="poemNumSupport" column="poem_num_support" />
		<result property="poemNumComment" column="poem_num_comment" />
		<result property="poemNumTransmit" column="poem_num_transmit" />
		<result property="poemPublishTime" column="poem_publish_time" />
		<result property="poemImg" column="poem_img" />
		<result property="labelId" column="label_id" />
		<result property="labelName" column="label_name" />
	</resultMap>
	<resultMap type="com.crm.util.PoemUtil" id="poemUtilMap">
		<id property="poemId" column="poem_id"/>
		<result property="userId" column="user_id" />
		<result property="userName" column="user_name" />
		<result property="poemText" column="poem_text" />
		<result property="poemTitle" column="poem_title" />
		<result property="poemNumSupport" column="poem_num_support" />
		<result property="poemNumComment" column="poem_num_comment" />
		<result property="poemNumTransmit" column="poem_num_transmit" />
		<result property="poemPublishTime" column="poem_publish_time" />
		<result property="poemImg" column="poem_img" />
	</resultMap>
	<resultMap type="com.crm.util.HomePoemUtil" id="homePoemUtilMap">
		<result property="poemId" column="poem_id" />
		<result property="poemTitle" column="poem_title" />
		<result property="poemImg" column="poem_img" />
	</resultMap>
	<resultMap type="com.crm.util.HomeOtherPoemUtil" id="homeOtherPoemUtilMap">
		<result property="poemId" column="id" />
		<result property="poemTitle" column="poem_title" />
		<result property="authorName" column="author_name" />
	</resultMap>
	<resultMap type="com.crm.model.OtherPoem" id="otherPoemMap">
		<result property="poemId" column="id" />
		<result property="poemTitle" column="poem_title" />
		<result property="authorName" column="author_name" />
		<result property="poemText" column="poem_text" />
		<result property="publishTime" column="publish_time" />
	</resultMap>
	
	<sql id="poemColumns">
		poem_id,user_id,poem_text,poem_title,poem_num_support,poem_num_comment,
		poem_num_transmit,poem_publish_time,poem_img
	</sql>
	<sql id="poemUtilColumns">
		poem_id,MP_user.user_id,user_name,poem_text,poem_title,poem_num_support,
		poem_num_comment,poem_num_transmit,poem_publish_time,poem_img
	</sql>
	
	<insert id="insertPoem" parameterType="com.crm.model.Poem" useGeneratedKeys="true" keyProperty="poemId">
		insert into MP_poem(user_id,poem_title,poem_text,poem_publish_time,label_id,label_name
		<if test="poemImg!=null">,poem_img</if>
		)
		values(#{userId},#{poemTitle},#{poemText},#{poemPublishTime},#{labelId},#{labelName}
		<if test="poemImg!=null">,#{poemImg}</if>
		)
	</insert>
	
	<select id="getPoemById" resultMap="poemMap">
		select <include refid="poemColumns" /> from MP_poem
		where poem_id=#{0}
	</select>
	
	<select id="getPoemUtils" resultMap="poemUtilMap">
		select <include refid="poemUtilColumns" />
		from MP_poem,MP_user where MP_poem.user_id=MP_user.user_id; 	
	</select>
	
	<select id="getPoemUtilsByAId" resultMap="poemUtilMap">
		select <include refid="poemUtilColumns" />
		from MP_poem,MP_user where MP_poem.user_id=#{0} and MP_poem.user_id=MP_user.user_id
	</select>
	
	<update id="addSupport">
		update MP_poem set poem_num_support=poem_num_support+1
		where poem_id=#{0}
	</update>
	
	<update id="subSupport">
		update MP_poem set poem_num_support=poem_num_support-1
		where poem_id=#{0}
	</update>
	
	<select id="getPoemUtilById" resultMap="poemUtilMap">
		select <include refid="poemUtilColumns" /> from MP_poem,MP_user
		where MP_Poem.poem_id=#{0} and MP_user.user_id=MP_poem.user_id
	</select>
	
	<update id="addTransmit">
		update MP_poem set poem_num_transmit=poem_num_transmit+1
		where poem_id=#{0}
	</update>
	
	<update id="addComment">
		update MP_poem set poem_num_comment=poem_num_comment+1
		where poem_id=#{0}
	</update>
	
	<update id="subComment">
		update MP_poem set poem_num_comment=poem_num_comment-#{1}
		where poem_id=#{0}
	</update>
	
	<select id="getCreationsByUId" resultMap="poemMap">
		select <include refid="poemColumns" /> from MP_poem
		where user_id=#{0} limit #{1},#{2}
	</select>
	
	<select id="getPoemNumberByUId" resultType="int">
		select count(poem_id) from MP_poem where user_id=#{0}
	</select>
	
	<delete id="removePoem">
		delete from MP_poem where poem_id=#{0} and user_id=#{1}
	</delete>
	
	<select id="getHomePoemUtils" resultMap="homePoemUtilMap">
		select poem_id,poem_title,poem_Img from MP_poem,MP_recommend_poem
		where MP_recommend_poem.pid=MP_poem.poem_id limit 0,3
	</select>
	
	<select id="getHomeOtherPoemUtils" resultMap="homeOtherPoemUtilMap">
		select id,author_name,poem_title from MP_other_recommend limit 0,11;
	</select>
	
	<select id="getPoemUtilsByLId" resultMap="poemUtilMap">
		select <include refid="poemUtilColumns" /> from MP_poem,MP_user
		where MP_Poem.label_id=#{0} and MP_user.user_id=MP_poem.user_id
	</select>
	
	<select id="getOtherPoemNumber" resultType="int">
		select count(id) from MP_other_recommend
	</select>
	
	<select id="getOtherPoemListByPage" resultMap="otherPoemMap">
		select id,author_name,poem_title,poem_text,publish_time 
		from MP_other_recommend limit #{0},#{1}
	</select>
	
	<select id="getOtherPoemById" resultMap="otherPoemMap">
		select id,author_name,poem_title,poem_text,publish_time 
		from MP_other_recommend where id=#{0}
	</select>
	
	<select id="getNextOtherPoemById" resultMap="otherPoemMap">
		select id,poem_title from MP_other_recommend 
		where id = (select id from MP_other_recommend where id &gt; #{0} order by id asc limit 1);  
	</select>
	<!-- <要转义 -->
	<select id="getPrevOtherPoemById" resultMap="otherPoemMap">
		select id,poem_title from MP_other_recommend 
		where id = (select id from MP_other_recommend where id &lt; #{0} order by id desc limit 1);  
	</select>
</mapper>